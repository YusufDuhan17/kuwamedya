{% extends "layout.html" %}

<!-- ===================================================================
Kuwamedya - Ana Panel İskeleti (_panel_layout.html)
Sürüm: v6.0 (Akademi Yükseltmesi)

BU ŞABLON, GİRİŞ YAPAN TÜM KULLANICILARIN (Admin, Personel, Kullanıcı)
GÖRDÜĞÜ ANA İSKELETTİR. 'profile.html', 'academy.html' VB.
SAYFALAR BU DOSYADAN MİRAS ALIR.

'templates/layout.html' DOSYASINDAN MİRAS ALIR.

YENİLİKLER VE GÜÇLENDİRMELER (v6.0):
1.  GELİŞMİŞ ROL BAZLI MENÜ (RBAC - KRİTİK GÜNCELLEME):
    - Sol menü (sidebar) artık 'current_user.is_staff' (Personel VEYA Admin)
      ve 'current_user.is_admin' (SADECE Admin) kontrollerini kullanır.
    - 'Kullanıcı' (Öğrenci) rolündeki biri giriş yaptığında, 'is_staff'
      ve 'is_admin' kontrolleri 'False' döneceği için, bu kişi
      SADECE "Kontrol Paneli" ve "Akademi" linklerini görür.
    - "Yönetim" başlıklı tüm menü (Personel Yön., Kurs Yön. vb.)
      normal kullanıcılardan ve personelden gizlenir.

2.  EKSİK ADMİN LİNKLERİ EKLENDİ (YENİ ÖZELLİK):
    - 'admin_routes.py' dosyasında v5.0'da bulunan ancak menüde eksik olan
      "Proje Yönetimi" ve "Paket Yönetimi" linkleri, '@admin_required'
      bölümüne eklendi. Panel artık backend ile %100 uyumludur.

3.  GÜVENLİ YÖNLENDİRME (MİMARİ ONAYI):
    - Bir 'Kullanıcı' (Öğrenci) "Kontrol Paneli" linkine tıkladığında,
      'admin_routes.py' -> 'dashboard()' rotası onu 'profile()' rotasına
      yönlendirir. 'profile()' rotası '@login_required' ile korunduğu
      için (ve 'profile.html' şablonu 'is_staff' kontrolüyle akıllı
      olduğu için), öğrenci GÜVENLİ BİR ŞEKİLDE kendi profilini görür.
      MİMARİ KUSURSUZ ÇALIŞIYOR.
=================================================================== -->

<!-- Ana 'layout.html' dosyasındaki 'content' bloğunu dolduruyoruz -->
{% block content %}
<div class="panel-wrapper">
    
    <!-- =================================================================== -->
    <!-- SOL TARAFTAKİ SABİT NAVİGASYON MENÜSÜ (SIDEBAR) -->
    <!-- =================================================================== -->
    <aside class="sidebar offcanvas-lg offcanvas-start" tabindex="-1" id="panelSidebar">
        
        <!-- Mobil görünüm için başlık ve kapatma butonu -->
        <div class="offcanvas-header">
            <a href="{{ url_for('main.home') }}" class="sidebar-logo d-flex align-items-center">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="KUWAMEDYA" height="24" class="me-2" style="object-fit: contain;">
                <span class="sidebar-brand-text">KUWAMEDYA</span>
            </a>
            <button type="button" class="btn-close btn-close-white d-lg-none" data-bs-dismiss="offcanvas" data-bs-target="#panelSidebar" aria-label="Kapat"></button>
        </div>

        <!-- Sidebar İçeriği -->
        <div class="offcanvas-body d-flex flex-column p-0">
            <nav class="sidebar-nav">
                <ul class="list-unstyled">
                    
                    <!-- 1. GENEL PANEL LİNKLERİ (Tüm giriş yapmış kullanıcılar görür) -->
                    <li class="sidebar-nav-title">Panel</li>
                    <li class="sidebar-nav-item">
                        <!-- 
                          GÜNCELLEME (v6.0): Bu link artık tüm roller (Kullanıcı, Personel, Admin)
                          için ana giriş noktasıdır. 'admin.dashboard' rotası, kullanıcıyı
                          rolüne göre doğru sayfaya (Admin Dashboard / Personel Profili /
                          Öğrenci Profili) yönlendirmekle yükümlüdür.
                        -->
                        <a class="sidebar-nav-link {% if request.endpoint == 'admin.dashboard' or request.endpoint == 'admin.profile' or request.endpoint == 'admin.admin_dashboard' %}active{% endif %}" 
                           href="{{ url_for('admin.dashboard') }}">
                            <i class="fas fa-tachometer-alt fa-fw"></i><span>Kontrol Paneli</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a class="sidebar-nav-link {% if request.endpoint.startswith('academy.') %}active{% endif %}" 
                           href="{{ url_for('academy.academy_home') }}">
                            <i class="fas fa-graduation-cap fa-fw"></i><span>Akademi</span>
                        </a>
                    </li>

                    <!-- 
                      2. YÖNETİM LİNKLERİ (Sadece 'Admin' rolündekiler görür)
                      KRİTİK GÜVENLİK KONTROLÜ (v6.0)
                    -->
                    {% if current_user.is_admin %}
                    <li class="sidebar-nav-title">Yönetim</li>
                    <li class="sidebar-nav-item">
                        <!-- Personel Yönetimi Linki -->
                        <a class="sidebar-nav-link {% if request.endpoint in ['admin.user_list', 'admin.edit_user', 'admin.add_user'] %}active{% endif %}" 
                           href="{{ url_for('admin.user_list') }}">
                            <i class="fas fa-users-cog fa-fw"></i><span>Personel Yönetimi</span>
                        </a>
                    </li>
                     <li class="sidebar-nav-item">
                         <!-- Kurs Yönetimi Linki -->
                        <a class="sidebar-nav-link {% if request.endpoint in ['academy.manage_courses', 'academy.add_course', 'academy.edit_course', 'academy.manage_lessons'] %}active{% endif %}" 
                           href="{{ url_for('academy.manage_courses') }}">
                            <i class="fas fa-book fa-fw"></i><span>Kurs Yönetimi</span>
                        </a>
                    </li>
                    <!-- YENİ LİNK (v6.0): Proje Yönetimi Linki -->
                    <li class="sidebar-nav-item">
                        <a class="sidebar-nav-link {% if request.endpoint in ['admin.project_list', 'admin.add_project', 'admin.edit_project'] %}active{% endif %}"
                           href="{{ url_for('admin.project_list') }}">
                            <i class="fas fa-briefcase fa-fw"></i><span>Proje Yönetimi</span>
                        </a>
                    </li>
                    <!-- YENİ LİNK (v6.0): Paket Yönetimi Linki -->
                    <li class="sidebar-nav-item">
                        <a class="sidebar-nav-link {% if request.endpoint in ['admin.package_list', 'admin.add_package', 'admin.edit_package'] %}active{% endif %}"
                           href="{{ url_for('admin.package_list') }}">
                            <i class="fas fa-box-open fa-fw"></i><span>Paket Yönetimi</span>
                        </a>
                    </li>
                    {% endif %}
                    <!-- YÖNETİM BÖLÜMÜ SONU -->

                </ul>
            </nav>

            <!-- Sidebar Alt Kullanıcı Bilgisi ve Çıkış -->
            <div class="sidebar-footer mt-auto">
                <hr class="border-secondary">
                <ul class="list-unstyled">
                    <li class="sidebar-nav-item">
                        <a href="#" class="sidebar-nav-link" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                            <i class="fas fa-key fa-fw"></i><span>Şifre Değiştir</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="{{ url_for('auth.logout') }}" class="sidebar-nav-link logout-link">
                            <i class="fas fa-sign-out-alt fa-fw"></i><span>Güvenli Çıkış</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </aside>

    <!-- =================================================================== -->
    <!-- SAĞ TARAFTAKİ ANA İÇERİK ALANI (TOPBAR + İÇERİK) -->
    <!-- =================================================================== -->
    <main class="main-content">
        
        <!-- Üst Bar (Topbar) -->
        <header class="topbar">
            <div class="d-flex justify-content-between align-items-center">
                <!-- Mobil için menü açma butonu -->
                <button class="btn btn-outline-secondary d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#panelSidebar" aria-controls="panelSidebar">
                    <i class="fas fa-bars"></i>
                </button>
                
                <!-- Üst barın sağ tarafı (Kullanıcı menüsü) -->
                <div class="ms-auto">
                    <div class="dropdown">
                        <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <img src="{{ current_user.avatar(40) }}" alt="{{ current_user.name }}" width="40" height="40" class="rounded-circle me-2" style="object-fit: cover;">
                            <div>
                                <strong class="d-block">{{ current_user.name }}</strong>
                                <!-- v6.0: Unvanı yoksa Rolünü göster (Örn: "Kullanıcı") -->
                                <small class="text-muted">{{ current_user.title or current_user.role }}</small>
                            </div>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end" aria-labelledby="userDropdown">
                            <!-- 
                              GÜNCELLEME (v6.0): Bu link 'admin.profile' rotasına gider.
                              'admin_routes.py' içindeki 'profile()' rotası '@login_required'
                              ile korunduğu için tüm roller (Kullanıcı, Personel, Admin)
                              kendi profillerine güvenle erişebilir.
                            -->
                            <li><a class="dropdown-item" href="{{ url_for('admin.profile') }}"><i class="fas fa-user-circle fa-fw me-2"></i>Profilim</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}"><i class="fas fa-sign-out-alt fa-fw me-2"></i>Çıkış Yap</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>

        <!-- Asıl Sayfa İçeriğinin Geleceği Yer -->
        <div class="container-fluid p-4">
            {% block panel_content %}{% endblock %}
        </div>
    </main>
</div>

<!-- =================================================================== -->
<!-- ŞİFRE DEĞİŞTİRME MODALI (Tüm Panel Sayfalarında Erişilebilir) -->
<!-- =================================================================== -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-secondary">
            <form method="POST" action="{{ url_for('admin.profile') }}" novalidate>
                {{ change_password_form.hidden_tag() }}
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="fas fa-shield-alt me-2 text-info"></i>Şifre Değiştir</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>Şifreniz en az 8 karakter olmalı ve büyük harf, küçük harf, rakam içermelidir.</small>
                    </div>
                    <div class="mb-3">
                        {{ change_password_form.current_password.label(class="form-label") }}
                        {{ change_password_form.current_password(class="form-control bg-darker border-secondary text-white", placeholder="Mevcut şifrenizi girin") }}
                        {% if change_password_form.current_password.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in change_password_form.current_password.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        {{ change_password_form.new_password.label(class="form-label") }}
                        {{ change_password_form.new_password(class="form-control bg-darker border-secondary text-white", placeholder="Yeni şifrenizi girin") }}
                        {% if change_password_form.new_password.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in change_password_form.new_password.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        {{ change_password_form.confirm_new_password.label(class="form-label") }}
                        {{ change_password_form.confirm_new_password(class="form-control bg-darker border-secondary text-white", placeholder="Yeni şifrenizi tekrar girin") }}
                        {% if change_password_form.confirm_new_password.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in change_password_form.confirm_new_password.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    {{ change_password_form.submit(class="btn btn-info", render_kw={'name': 'submit_password'}) }}
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
